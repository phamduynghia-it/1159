<!doctype html>
<html>
    <meta charset="utf-8" />

    <head>
        <title>LOVE YOU</title>
    </head>

    <body>
        <audio id="bgMusic" src="music.mp3" preload="auto" loop></audio>

        <!-- FIREWORK BACKGROUND -->
        <canvas id="canvas"></canvas>

        <!-- TEXT PARTICLES -->
        <canvas id="countdownCanvas"></canvas>

        <!-- HEART EFFECT -->
        <canvas id="pinkboard"></canvas>

        <div
            id="tapHint"
            style="
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translateX(-50%);
                color: #aaa;
                font-size: 18px;
                z-index: 20;
            "
        >
            Nháº¥n vÃ o mÃ n hÃ¬nh Ä‘á»ƒ báº¯t Ä‘áº§u
        </div>

        <div id="child" style="display: none"></div>

        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: black;
            }

            canvas {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #canvas {
                z-index: 1;
            }

            #countdownCanvas {
                z-index: 10;
            }

            #pinkboard {
                z-index: 5;
            }

            #child {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 15;
            }

            h4 {
                font-family: Mali, Arial;
                font-size: 40px;
                color: #fff;
                margin: 0;
            }
        </style>

        <!-- ================= FIREWORK BACKGROUND ================= -->
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = innerWidth;
            canvas.height = innerHeight;

            const isMobile = innerWidth < 768;
            const fireworks = [];
            const particles = [];
            const MAX_PARTICLES = isMobile ? 120 : 280;
            const stars = [];
            const STAR_COUNT = isMobile ? 60 : 120;

            for (let i = 0; i < STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 1.2 + 0.3,
                    a: Math.random(),
                    da: Math.random() * 0.02 + 0.005,
                });
            }

            function drawStars() {
                stars.forEach((s) => {
                    s.a += s.da;
                    if (s.a >= 1 || s.a <= 0) s.da *= -1;

                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${s.a})`;
                    ctx.fill();
                });
            }
            class Firework {
                constructor(type) {
                    this.type = type;
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height;
                    this.ty = Math.random() * canvas.height * 0.5;
                    this.vy = -(isMobile ? 6 : 8);
                }
                update() {
                    this.y += this.vy;
                    if (this.y <= this.ty) {
                        explode(this.x, this.y, this.type);
                        return false;
                    }
                    return true;
                }
                draw() {
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(this.x, this.y, 2, 2);
                }
            }

            function explode(x, y, type) {
                let count = isMobile ? 20 : 30;
                let angleStep = (Math.PI * 2) / count;

                for (let i = 0; i < count; i++) {
                    let angle = angleStep * i;
                    let speed = Math.random() * 3 + 2;

                    let vx = Math.cos(angle) * speed;
                    let vy = Math.sin(angle) * speed;

                    if (type === "rain") vy = Math.random() * 3 + 2;
                    if (type === "star") speed *= 1.4;

                    particles.push({
                        x,
                        y,
                        vx,
                        vy,
                        life: isMobile ? 40 : 60,
                    });
                }
            }

            function launchSalvo() {
                let shots = Math.floor(Math.random() * 3) + 2; // 2â€“4 quáº£
                const types = ["classic", "star", "rain"];

                for (let i = 0; i < shots; i++) {
                    fireworks.push(
                        new Firework(
                            types[Math.floor(Math.random() * types.length)],
                        ),
                    );
                }
            }

            function animate() {
                ctx.fillStyle = "rgba(0,0,0,0.2)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawStars();
                if (Math.random() < 0.04) launchSalvo();

                fireworks.forEach((f, i) => {
                    if (!f.update()) fireworks.splice(i, 1);
                    else f.draw();
                });

                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;

                    ctx.fillStyle = "#fff";
                    ctx.fillRect(p.x, p.y, 2, 2);

                    if (p.life <= 0 || particles.length > MAX_PARTICLES)
                        particles.splice(i, 1);
                });

                requestAnimationFrame(animate);
            }
            animate();
        </script>

        <script>
            /* ================= COUNTDOWN PARTICLES ================= */
            var countdownParticles = [];
            var countdownTexts = [
                "3",
                "2",
                "1",
                " NÄƒm má»›i chÃºc e\n lun bÃ¬nh an",
                "Mong e váº¡n \nsá»± nhÆ° Ã½",
                "May máº¯n theo\n em cáº£ nÄƒm",
                "Tiá»n Ä‘áº§y vÃ­,\n tim Ä‘áº§y yÃªu",
                "Cáº£ nÄƒm rá»±c rá»¡\n nha bÃ© Tháº£oâ¤ï¸",
            ];

            var currentTextIndex = 0;
            var countdownStage = "idle"; // idle | forming | holding | dispersing
            var stableTime = 0; // biáº¿n Ä‘áº¿m thá»i gian

            // --- Cáº¤U HÃŒNH THá»œI GIAN á»ž ÄÃ‚Y ---
            var STABLE_DURATION = 150; // TÄƒng lÃªn 500 Ä‘á»ƒ chá»¯ giá»¯ nÃ©t lÃ¢u hÆ¡n (táº§m 8-9 giÃ¢y)
            var FORMING_SPEED = 0.1; // TÄƒng tá»‘c Ä‘á»™ bay tá»« 0.1 lÃªn 0.35 Ä‘á»ƒ giáº£m thá»i gian bá»‹ vá»¡
            // -------------------------------

            var countdownHoldTime = 0;
            var countdownCtx = document
                .getElementById("countdownCanvas")
                .getContext("2d");

            var started = false;
            var pinkboardStarted = false;
            var particleSize = 3;
            var particleDensity = 6; // Giáº£m nháº¹ máº­t Ä‘á»™ Ä‘á»ƒ Ä‘á»¡ lag náº¿u mÃ¡y yáº¿u

            function initCountdownCanvas() {
                var canvas = document.getElementById("countdownCanvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            function createTextParticles(text) {
                countdownParticles = [];
                text = text.replace(/\s+\n/g, "\n");
                var lines = text.split("\n").map((s) => s.trim());

                var tempCanvas = document.createElement("canvas");
                var tempCtx = tempCanvas.getContext("2d");

                var maxAllowedWidth = window.innerWidth * 0.8;
                var fontSize = Math.min(window.innerWidth / 8, 220);
                tempCtx.font = `bold ${fontSize}px Arial`;

                function measure() {
                    return Math.max(
                        ...lines.map((l) => tempCtx.measureText(l).width),
                    );
                }
                while (measure() > maxAllowedWidth && fontSize > 18) {
                    fontSize *= 0.9;
                    tempCtx.font = `bold ${fontSize}px Arial`;
                }

                var lineHeight = fontSize * 1.2;
                tempCanvas.width = window.innerWidth;
                tempCanvas.height = lineHeight * lines.length + fontSize;

                tempCtx.font = `bold ${fontSize}px Arial`;
                tempCtx.fillStyle = "#fff";
                tempCtx.textAlign = "center";
                tempCtx.textBaseline = "middle";
                tempCtx.shadowColor = "#800080";
                tempCtx.shadowBlur = 8;

                var startY =
                    tempCanvas.height / 2 -
                    ((lines.length - 1) * lineHeight) / 2;
                lines.forEach((l, i) => {
                    tempCtx.fillText(
                        l,
                        tempCanvas.width / 2,
                        startY + i * lineHeight,
                    );
                });

                var data = tempCtx.getImageData(
                    0,
                    0,
                    tempCanvas.width,
                    tempCanvas.height,
                ).data;
                for (var y = 0; y < tempCanvas.height; y += particleDensity) {
                    for (
                        var x = 0;
                        x < tempCanvas.width;
                        x += particleDensity
                    ) {
                        if (data[(y * tempCanvas.width + x) * 4 + 3] > 128) {
                            countdownParticles.push({
                                x: Math.random() * window.innerWidth, // Vá»‹ trÃ­ ban Ä‘áº§u ngáº«u nhiÃªn
                                y: Math.random() * window.innerHeight,
                                targetX:
                                    x -
                                    tempCanvas.width / 2 +
                                    window.innerWidth / 2,
                                targetY:
                                    y -
                                    tempCanvas.height / 2 +
                                    window.innerHeight / 2,
                                vx: 0,
                                vy: 0,
                                size: particleSize,
                            });
                        }
                    }
                }
            }

            function updateCountdownParticles() {
                if (!started) return;

                countdownCtx.clearRect(
                    0,
                    0,
                    window.innerWidth,
                    window.innerHeight,
                );
                var done = true;

                countdownParticles.forEach((p) => {
                    if (countdownStage === "forming") {
                        // TÄƒng tá»‘c Ä‘á»™ bay vá» Ä‘Ã­ch Ä‘á»ƒ giáº£m thá»i gian "vá»¡"
                        p.vx = (p.targetX - p.x) * FORMING_SPEED;
                        p.vy = (p.targetY - p.y) * FORMING_SPEED;

                        // Cáº­p nháº­t vá»‹ trÃ­
                        p.x += p.vx;
                        p.y += p.vy;

                        // Kiá»ƒm tra xem Ä‘Ã£ Ä‘áº¿n nÆ¡i chÆ°a (sai sá»‘ nhá» hÆ¡n 1px)
                        if (
                            Math.abs(p.targetX - p.x) > 1 ||
                            Math.abs(p.targetY - p.y) > 1
                        ) {
                            done = false;
                        } else {
                            // Náº¿u Ä‘Ã£ ráº¥t gáº§n, gÃ¡n cá»©ng vá»‹ trÃ­ Ä‘á»ƒ chá»¯ sáº¯c nÃ©t
                            p.x = p.targetX;
                            p.y = p.targetY;
                        }
                    } else if (countdownStage === "stable") {
                        // Khi Ä‘Ã£ á»•n Ä‘á»‹nh, khÃ³a cá»©ng vá»‹ trÃ­ tuyá»‡t Ä‘á»‘i, khÃ´ng rung láº¯c
                        p.x = p.targetX;
                        p.y = p.targetY;
                    }
                    // Giai Ä‘oáº¡n dispersing (tan rÃ£) náº¿u muá»‘n thÃªm hiá»‡u á»©ng ná»• thÃ¬ code á»Ÿ Ä‘Ã¢y
                    // Hiá»‡n táº¡i code cÅ© chá»‰ chuyá»ƒn text luÃ´n nÃªn ko cáº§n xá»­ lÃ½

                    countdownCtx.beginPath();
                    countdownCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    countdownCtx.fillStyle = "#fff";
                    countdownCtx.fill();
                });

                if (countdownStage === "forming" && done) {
                    countdownStage = "stable"; // Chuyá»ƒn sang cháº¿ Ä‘á»™ giá»¯ nÃ©t
                    stableTime = 0;
                }

                if (countdownStage === "stable") {
                    // ðŸš« Náº¾U LÃ€ CÃ‚U CUá»I â†’ GIá»® MÃƒI, KHÃ”NG TAN
                    if (currentTextIndex === countdownTexts.length - 1) {
                        // khÃ³a vÄ©nh viá»…n á»Ÿ tráº¡ng thÃ¡i stable
                        return requestAnimationFrame(updateCountdownParticles);
                    }

                    stableTime++;
                    if (stableTime > STABLE_DURATION) {
                        countdownStage = "dispersing";
                    }
                }

                if (countdownStage === "dispersing") {
                    currentTextIndex++;
                    if (currentTextIndex < countdownTexts.length) {
                        createTextParticles(countdownTexts[currentTextIndex]);
                        countdownStage = "forming";
                    } else {
                        document.getElementById(
                            "countdownCanvas",
                        ).style.display = "none";
                        document.getElementById("child").style.display =
                            "block";
                        if (!pinkboardStarted) initPinkboard();
                        return;
                    }
                }
                requestAnimationFrame(updateCountdownParticles);
            }
        </script>
        <!-- ================= COUNTDOWN TEXT (GIá»® NGUYÃŠN) ================= -->
        <!-- (Giá»¯ nguyÃªn toÃ n bá»™ code chá»¯ báº¡n gá»­i â€“ KHÃ”NG Sá»¬A) -->
        <!-- ðŸ‘‰ VÃ¬ quÃ¡ dÃ i nÃªn mÃ¬nh KHÃ”NG láº·p láº¡i á»Ÿ Ä‘Ã¢y -->
        <!-- ðŸ‘‰ Báº¡n giá»¯ nguyÃªn toÃ n bá»™ script countdownParticles cÅ© -->

        <!-- ================= CLICK START ================= -->

        <script>
            function startLove(e) {
                if (started) return;
                started = true;

                document.getElementById("tapHint").style.display = "none";

                const audio = document.getElementById("bgMusic");
                audio.volume = 0.8;
                audio.currentTime = 0;

                // ðŸ”“ UNLOCK + PLAY TRONG CÃ™NG GESTURE
                audio
                    .play()
                    .then(() => {
                        // OK cho Android + iOS
                    })
                    .catch(() => {
                        console.log("Audio bá»‹ cháº·n");
                    });

                // START TEXT
                initCountdownCanvas();
                createTextParticles(countdownTexts[0]);
                countdownStage = "forming";
                updateCountdownParticles();
            }

            document.addEventListener("touchstart", startLove, { once: true });
            document.addEventListener("click", startLove, { once: true });
        </script>
    </body>
</html>
